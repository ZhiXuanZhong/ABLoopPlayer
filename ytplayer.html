<!DOCTYPE html>
<!--
  ytplayer.html

  YouTube video player with A-B loop, slow motion and bookmarking
  functionality

  Copyright (C) 2016  Alexander Grahn

  This file is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This file is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="description" content="YT player with loop function and slow motion playback">
  <meta name="author" content="Alexander Grahn">
  <meta name="date" content="2016/10/19">

  <!-- jQuery framework -->
  <link href="jquery-ui/jquery-ui.css" rel="stylesheet">
  <script src="jquery-ui/external/jquery/jquery.js"></script>
  <script src="jquery-ui/jquery-ui.js"></script>

  <link href="css/common.css" rel="stylesheet">
  <script src="js/common.js"></script>
</head>

<body onload="onLoad()" style="min-width: max-content; display: inline-block;">

<h1 style="font-size: 150%;">YT Player with loop function</h1>
<p>Firefox or Chrome recommended.<br>Also try the <a href="vplayer.html">MP4/WebM/Ogg Player</a> for local video files.</p>

<hr>
<div id="topElements" style="margin-bottom: 5px;">
  YT Video ID: <input id="myVidId" list="videoids" value="8bpVfMDSZSU"/>
  <datalist id="videoids"></datalist>
  <button id="loadButton" onclick="loadVideo()" disabled>Load</button>
  <span style="float: right;"><input type="checkbox"
    onchange="contextHelp(this)" id="help" checked>?</input></span>
</div>

<div id="myResizable" style="background: #ddd;">
  <!-- to be replaced by the <iframe> that displays the YouTube player -->
  <div id="ytplayer"></div>
</div>

<div id="timeInputs" hidden="true">
  <!-- placeholder for jQuery range slider -->
  <div id="slider" style="margin-top: 5px; margin-bottom: 8px;"></div>
  A: <input id="myTimeA" onchange="onInputTime(this,0)" size="8"/>
  B: <input id="myTimeB" onchange="onInputTime(this,1)" size="8"/>
  <button id="bmkAddButton" onmouseup="bmkAdd(myTimeA.value + '--' + myTimeB.value)">
    Add Bookmark</button>
</div>

<div style="margin-top: 5px;">
A-B Loop: <input type="button" id="loopButton" value="A" onmousedown="onLoopDown()"/>
<span id="myBmkSpan" hidden>
  <style>select:invalid { color: gray; }</style>
  <select id="myBookmarks" size="1"
    onmousedown="
      this.size=Math.min(5,this.options.length);
    "
    onblur="onBmkSelect(this.selectedIndex);this.size=1;"
  >
    <option value="" selected disabled>Bookmarked</option>
  </select><!--
  --><button id="annotButton" style="width:1.5em; padding: 0px;"
    onclick="onClickAddNote(myBookmarks.selectedIndex)" disabled
    ><span class="ui-icon ui-icon-pencil"></span></button><!--
  --><button id="trashButton" style="width:1.5em; padding: 0px;"
    onclick="onClickTrash(myBookmarks.selectedIndex)"
  ><span class="ui-icon ui-icon-trash"></span></button>
</span>
</div>
Speed: <select id="mySpeed" onchange="mySetPlaybackRate(this.value)"
         style="margin-top: 5px;" disabled></select>
<hr>
Â© 2016 Alexander Grahn

<script id="mainScript">
  var timer=[];
  var loadButton = document.getElementById("loadButton");

  //Load the IFrame Player API code at the very end.
  var scriptTag1 = document.getElementById('mainScript');
  var scriptTag2 = document.createElement('script');
  scriptTag2.src = "https://www.youtube.com/iframe_api";
  scriptTag1.parentNode.insertBefore(scriptTag2, scriptTag1);

  //This function creates an <iframe> (and YouTube player)
  //after the API code has been downloaded.
  var player;
  function onYouTubeIframeAPIReady() {
    var playerWidth=$("#myResizable").width();
    initResizable();

    player = new YT.Player('ytplayer', {
      listType: 'search',
      width: playerWidth,
      height: 9/16*playerWidth,
      events: {
        onStateChange : onPlayerStateChange,
        onReady: onPlayerReady,
      }
    });
  }

  var myGetDuration = function(){
    return player.getDuration();
  }

  var myGetCurrentTime = function(){
    return player.getCurrentTime();
  }

  var mySetCurrentTime = function(t){
    player.seekTo(t,true);
  }

  var mySetPlaybackRate = function(r){
    player.setPlaybackRate(r);
  }

  var onPlayerStateChange = function(e){
    if (isTimeASet && isTimeBSet && e.data==YT.PlayerState.PLAYING)
      timer.push(setInterval(onTimeUpdate,25));
    else
      while(timer.length) clearInterval(timer.pop());

    if (e.data == -1){
      cancelABLoop();
    }else if(e.data==YT.PlayerState.CUED){
      e.target.playVideo();
      loopButton.disabled=false;

      //determine available playback rates and fill the #mySpeed select element
      var rates = player.getAvailablePlaybackRates();
      for(var i=0; i<rates.length; i++) {
        var c = document.createElement('OPTION');
        mySpeed.add(c); //append as a child to selector

        c.value = c.text = rates[i];
        if(rates[i] == 1.0) {
          c.text = "Normal";
          c.selected=true;
          mySetPlaybackRate(1);
        }
      }
      mySpeed.disabled=false;
    }
  }

  var initResizable = function(){
    $("#myResizable" ).resizable({
      aspectRatio: false,
      minWidth: 352,
      minHeight: 198,
      start: function(event,ui){
        document.getElementById("ytplayer").hidden=true;
      },
      stop: function(event,ui){
        player.setSize(ui.size.width,ui.size.height);
        document.getElementById("ytplayer").hidden=false;
      },
      resize: function(event,ui){
        $("#slider").width(ui.size.width);
      }
    });
  }

  var onPlayerReady = function(e){
    loadButton.disabled=false;
  }

  var loadVideo = function() {
    loopButton.disabled=true;
    vidId = document.getElementById("myVidId").value.toString().trim();

    if(vidId.length!==0 && typeof knownIDsHash[vidId]==='undefined'){
      knownIDsHash[vidId]='';
      knownIDs.unshift(vidId);

      var z = document.createElement('OPTION');
      z.setAttribute('value', vidId);
      document.getElementById('videoids').insertBefore(
          z, document.getElementById('videoids').firstChild);

      if(knownIDs.length>30) {
        knownIDs.pop();
        document.getElementById('videoids').removeChild(
            document.getElementById('videoids').lastChild);
      }

      localStorage.setItem('knownIDs', knownIDs.join());
    }

    player.cueVideoById({
      videoId: vidId
    });

    //remove all bookmark items from previous video
    bmkDelete(0);

    //look for bookmark items with this video ID
    if(localStorage.getItem(vidId)){
      var bmks = localStorage.getItem(vidId).split(',');
      for(var i=0; i<bmks.length; i++){
        bmkAdd(bmks[i]);
        myBookmarks.options[0].selected=true;
      }
      annotButton.disabled=true;
    }

    //remove all speed options
    mySpeed.disabled=true;
    while(mySpeed.options.length) mySpeed.remove(mySpeed.options.length-1);
  }

  var onBmkSelect = function(i){
    cancelABLoop();
    if(i==0) return;

    var a=timeStringToSec(myBookmarks.options[i].text.split('--')[0]);
    var b=timeStringToSec(myBookmarks.options[i].text.split('--')[1]);
    $("#slider").slider("option", "values", [ a, b ]);
    $("#slider").slider("option", "max", myGetDuration());
    isTimeASet=isTimeBSet=true;
    timeInputs.hidden=false;
    loopButton.value="Cancel";
    annotButton.disabled=false;
    if(player.getPlayerState()==YT.PlayerState.PLAYING)
      timer.push(setInterval(onTimeUpdate,30));
  }

  var cancelABLoop = function () {
    while(timer.length) clearInterval(timer.pop());
    isTimeASet=isTimeBSet=false;
    loopButton.value="A";
    timeInputs.hidden=true;
  }

  var onTimeUpdate = function () {
    if(myGetCurrentTime()<timeA||myGetCurrentTime()>=timeB)
      mySetCurrentTime(timeA);
  }

  var onLoopDown = function () {
    if(isTimeBSet){
      cancelABLoop();
      annotButton.disabled=true;
      myBookmarks.options[0].selected=true;
    }else{
      if(isTimeASet){
        if(myGetCurrentTime()!=timeA){
          if(myGetCurrentTime()<timeA){
            timeB=timeA;
            timeA=myGetCurrentTime();
          }else{
            timeB=myGetCurrentTime();
          }
          isTimeBSet=true;
          loopButton.value="Cancel";
          $("#slider").slider("option", "values", [ timeA, timeB ]);
          $("#slider").slider("option", "max", myGetDuration());
          timeInputs.hidden=false;

          if(player.getPlayerState()==YT.PlayerState.PLAYING)
            timer.push(setInterval(onTimeUpdate,25));
        }
      }else{
        timeA=myGetCurrentTime();
        isTimeASet=true;
        loopButton.value="B";
      }
    }
  }

  var knownIDs=new Array();
  var knownIDsHash=new Array();
  var onLoad = function () { //get already watched IDs
    try{
      if(localStorage.getItem('knownIDs')){
        knownIDs = localStorage.getItem('knownIDs').split(',');
        for(var i=0; i<knownIDs.length; i++){
          var z = document.createElement('OPTION');
          z.setAttribute('value', knownIDs[i]);
          document.getElementById('videoids').appendChild(z);
          knownIDsHash[knownIDs[i].toString()]='';
        }
      }
    }catch(e){}
  }

  var contextHelpLoadVideo = function(t) {
    if(t.checked) {
      myVidId.title = "Open video on youtube.com and "
        + "get its ID from the browser's address bar.";
    } else {
      myVidId.title = "";
    }
  }
</script>

</body>
</html>
