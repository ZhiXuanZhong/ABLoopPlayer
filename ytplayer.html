<!DOCTYPE html>
<!--
  ytplayer.html

  YouTube video player with A-B loop, slow motion and bookmarking
  functionality

  Copyright (C) 2016  Alexander Grahn

  This file is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This file is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="description" content="YT player with loop function and slow motion playback">
  <meta name="author" content="Alexander Grahn">
  <meta name="date" content="2016/09/26">

  <!-- jQuery framework -->
  <link href="jquery-ui/jquery-ui.css" rel="stylesheet">
  <script src="jquery-ui/external/jquery/jquery.js"></script>
  <script src="jquery-ui/jquery-ui.js"></script>
  
  <link href="css/common.css" rel="stylesheet">
  <script src="js/common.js"></script>
</head>

<body onload="onLoad()" style="white-space: nowrap; min-width: max-content; display: inline-block;">

<h1 style="font-size: 150%;">YT Player with loop function</h1>
<p>Firefox recommended.<br>Also try the <a href="vplayer.html">MP4/WebM/Ogg Player</a> for local video files.</p>

<hr>
YT Video ID: <input id="myVidId" list="videoids" value="8bpVfMDSZSU">
<datalist id="videoids"></datalist><button id="loadButton" onclick="loadVideo()" disabled>Load</button><hr>

<div id="myResizable" style="background: #ddd;">
  <!-- to be replaced by the <iframe> that displays the iYouTube pülayer -->
  <div id="ytplayer"></div>
</div>

<div id="timeInputs" hidden="true">
  <!-- jQuery range slider -->
  <div id="slider"></div><br>
  A: <input id="myTimeA" onchange="onInputTime(this,0)" title="[hh:]mm:ss[.sss]"></input>
  B: <input id="myTimeB" onchange="onInputTime(this,1)" title="[hh:]mm:ss[.sss]"></input>
  <button id="bmkAddButton" onmouseup="bmkAdd(myTimeA.value + '--' + myTimeB.value)">Add bookmark</button>
</div>

<div style="margin-top: 5px;">
A-B Loop: <input type="button" id="loopButton" value="A" onmousedown="onLoopDown()"></input>
<span id="myBmkSpan" hidden>
  <style>select:invalid { color: gray; }</style>
  <select id="myBookmarks" onchange="onBmkSelect(this.selectedIndex)">
    <option value="" selected disabled>Bookmarked</option>
  </select><!--
  --><button id="annotButton" style="width:1.5em; padding: 0px;" title="Add a note"
    onclick="onClickAddNote(myBookmarks.selectedIndex)" disabled
    ><span class="ui-icon ui-icon-pencil"></span></button><!--
  --><button id="trashButton" style="width:1.5em; padding: 0px;" title="Delete bookmarked loop(s)"
    onclick="onClickTrash(myBookmarks.selectedIndex)"
  ><span class="ui-icon ui-icon-trash"></span></button>
</span>
<span style="display:inline-block; margin-left: 20px;"></span>
  Set speed: <input type="button" id="slowButton" value="Slow" onmousedown="onSlowDown()"></input>
</div>
<hr>
© 2016 Alexander Grahn

<script>
  var timer=[];
  var loadButton = document.getElementById("loadButton");

  //This code loads the IFrame Player API code asynchronously.
  var scriptTag1 = document.getElementsByTagName('script')[0];
  var scriptTag2 = document.createElement('script');
  scriptTag2.src = "https://www.youtube.com/iframe_api";
  scriptTag1.parentNode.insertBefore(scriptTag2, scriptTag1);

  //This function creates an <iframe> (and YouTube player)
  //after the API code downloads.
  var player;
  function onYouTubeIframeAPIReady() {
    player = new YT.Player('ytplayer', {
      listType: 'search',
      width: playerWidth,
      height: 9/16*playerWidth,
      events: {
        onStateChange : onPlayerStateChange,
        onReady: onPlayerReady,
      }
    });
  }

  var myGetDuration = function(){
    return player.getDuration();
  }

  var myGetCurrentTime = function(){
    return player.getCurrentTime();
  }

  var onPlayerStateChange = function(e){
    if (isTimeASet && isTimeBSet && e.data==YT.PlayerState.PLAYING)
      timer.push(setInterval(onTimeUpdate,30));
    else
      while(timer.length) clearInterval(timer.pop());

    if (e.data == -1){
      cancelABLoop();
      e.target.setPlaybackRate(1.0);
      slowButton.value="Slow";
    }else if(e.data==YT.PlayerState.CUED){
      e.target.playVideo();
      loopButton.disabled=false;
    }
  }

  var initResizable = function(){
    $("#myResizable" ).resizable({
      aspectRatio: false,
      minWidth: 352,
      minHeight: 198,
      create: function(e,ui){
        $("#slider").width(playerWidth);
      },
      resize: function(event,ui){
        $("#slider").width(ui.size.width);
      },
      start: function(event,ui){
        document.getElementById("ytplayer").hidden=true;
      },
      stop: function(event,ui){
        player.setSize(ui.size.width,ui.size.height);
        document.getElementById("ytplayer").hidden=false;
      }
    });
  }

  var onPlayerReady = function(e){
    loadButton.disabled=false;
    //initialize resizable
    initResizable();
  }

  var loadVideo = function() {
    loopButton.disabled=true;
    vidId = document.getElementById("myVidId").value.toString().trim();

    if(vidId.length!==0 && typeof knownIDsHash[vidId]==='undefined'){
      knownIDsHash[vidId]='';
      knownIDs.unshift(vidId);

      var z = document.createElement('OPTION');
      z.setAttribute('value', vidId);
      document.getElementById('videoids').insertBefore(
          z, document.getElementById('videoids').firstChild);

      if(knownIDs.length>30) {
        knownIDs.pop();
        document.getElementById('videoids').removeChild(
            document.getElementById('videoids').lastChild);
      }

      localStorage.setItem('knownIDs', knownIDs.join());
    }

    player.cueVideoById({
      videoId: vidId
    });

    //remove all bookmark items from previous video
    bmkDelete(0);

    //look for bookmark items with this video ID
    if(localStorage.getItem(vidId)){
      var bmks = localStorage.getItem(vidId).split(',');
      for(var i=0; i<bmks.length; i++){
        bmkAdd(bmks[i]);
        myBookmarks.options[0].hidden=false;
        myBookmarks.options[0].selected=true;
      }
      annotButton.disabled=true;
    }
  }

  var bmkDelete = function(idx) {
    if(idx==0){
      while(myBookmarks.options.length>1)
        myBookmarks.remove(myBookmarks.options.length-1);
      bmkHash=[];
      bmkArr=[];
    }else{
      bmkArr.splice(idx-1,1);
      bmkHash[myBookmarks.options[idx].text]=undefined;
      myBookmarks.remove(idx);
    }
    if(myBookmarks.options.length==1){
      myBookmarks.options[0].hidden=false;
      myBookmarks.options[0].selected=true;
    }
  }

  var onBmkSelect = function(i){
    cancelABLoop();
    if(i==0) return;

    var a=timeStringToSec(myBookmarks.options[i].text.split('--')[0]);
    var b=timeStringToSec(myBookmarks.options[i].text.split('--')[1]);
    $("#slider").slider("option", "max", myGetDuration());
    $("#slider").slider("option", "values", [a, b]);
    isTimeASet=isTimeBSet=true;
    timeInputs.hidden=false;
    loopButton.value="Cancel";
    myBookmarks.options[0].hidden=true;
    annotButton.disabled=false;
    if(player.getPlayerState()==YT.PlayerState.PLAYING)
      timer.push(setInterval(onTimeUpdate,30));
  }

  var cancelABLoop = function () {
    while(timer.length) clearInterval(timer.pop());
    isTimeASet=isTimeBSet=false;
    loopButton.value="A";
    timeInputs.hidden=true;
  }

  var onTimeUpdate = function () {
    if(myGetCurrentTime()<timeA||myGetCurrentTime()>=timeB)
      player.seekTo(timeA,true);
  }

  var onLoopDown = function () {
    if(isTimeBSet){
      cancelABLoop();
      annotButton.disabled=true;
      myBookmarks.options[0].hidden=false;
      myBookmarks.options[0].selected=true;
    }else{
      if(isTimeASet){
        if(myGetCurrentTime()!=timeA){
          if(myGetCurrentTime()<timeA){
            timeB=timeA;
            timeA=myGetCurrentTime();
          }else{
            timeB=myGetCurrentTime();
          }
          isTimeBSet=true;
          loopButton.value="Cancel";
          $("#slider").slider("option", "max", myGetDuration());
          $("#slider").slider("option", "values", [ timeA, timeB ]);
          timeInputs.hidden=false;

          if(player.getPlayerState()==YT.PlayerState.PLAYING)
            timer.push(setInterval(onTimeUpdate,25));
        }
      }else{
        timeA=myGetCurrentTime();
        isTimeASet=true;
        loopButton.value="B";
      }
    }
  }

  var onSlowDown = function () {
    if(player.getPlaybackRate()==1){
      player.setPlaybackRate(0.5);
      slowButton.value="Fast";
    }else if(player.getPlaybackRate()==0.5){
      player.setPlaybackRate(2);
      slowButton.value="Normal";
    }else{
      player.setPlaybackRate(1);
      slowButton.value="Slow";
    }
  }

  var knownIDs=new Array();
  var knownIDsHash=new Array();
  var onLoad = function () { //get already watched IDs
    if(localStorage.getItem('knownIDs')){
      knownIDs = localStorage.getItem('knownIDs').split(',');
      for(var i=0; i<knownIDs.length; i++){
        var z = document.createElement('OPTION');
        z.setAttribute('value', knownIDs[i]);
        document.getElementById('videoids').appendChild(z);
        knownIDsHash[knownIDs[i].toString()]='';
      }
    }
  }
</script>

</body>
</html>
