<!DOCTYPE html>
<!--
  vplayer.html

  MP4/WebM/Ogg video player with A-B loop, slow motion and bookmarking
  functionality

  Copyright (C) 2016  Alexander Grahn

  This file is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This file is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="description" content="MP4/Ogg/WebM player with loop function and slow motion playback">
  <meta name="author" content="Alexander Grahn">
  <meta name="date" content="2016/09/26">

  <!-- jQuery framework -->
  <link href="jquery-ui/jquery-ui.css" rel="stylesheet">
  <script src="jquery-ui/external/jquery/jquery.js"></script>
  <script src="jquery-ui/jquery-ui.js"></script>
  
  <link href="css/common.css" rel="stylesheet">
  <script src="js/common.js"></script>
</head>

<body style="white-space: nowrap; min-width: max-content; display: inline-block;">

<h1 style="font-size: 150%;">MP4/WebM/Ogg Player with loop function</h1>
<p>Firefox recommended. Also try the <a href="ytplayer.html">YT Player</a> for online video.</p>

<hr>
<input id="myInput" accept="video/*" type="file" onchange="playSelectedFile(this.files[0])">
<hr>

<div id="myResizable"></div>

<div id="timeInputs" hidden="true">
  <!-- placeholder for jQuery range slider -->
  <div id="slider"></div><br>
  A: <input id="myTimeA" onchange="onInputTime(this,0)" title="[hh:]mm:ss[.sss]"></input>
  B: <input id="myTimeB" onchange="onInputTime(this,1)" title="[hh:]mm:ss[.sss]"></input>
  <button id="bmkAddButton" onmouseup="bmkAdd(myTimeA.value + '--' + myTimeB.value)">Add bookmark</button>
</div>

<div style="margin-top: 5px;">
A-B Loop: <input type="button" id="loopButton" value="A" onmousedown="onLoopDown()"></input>
<span id="myBmkSpan" hidden>
  <style>select:invalid { color: gray; }</style>
  <select id="myBookmarks" onchange="onBmkSelect(this.selectedIndex)">
    <option value="" selected disabled>Bookmarked</option>
  </select><!--
  --><button id="annotButton" style="width:1.5em; padding: 0px;" title="Add a note"
    onclick="onClickAddNote(myBookmarks.selectedIndex)" disabled
    ><span class="ui-icon ui-icon-pencil"></span></button><!--
  --><button id="trashButton" style="width:1.5em; padding: 0px;" title="Delete bookmarked loop(s)"
    onclick="onClickTrash(myBookmarks.selectedIndex)"
  ><span class="ui-icon ui-icon-trash"></span></button>
</span>
<span style="display:inline-block; margin-left: 20px;"></span>
  Set speed: <input type="button" id="slowButton" value="Slow" onmousedown="onSlowDown()"></input>
</div>
<hr>
Â© 2016 Alexander Grahn

<script>
  var URL = window.URL || window.webkitURL;

  //just to show it's a video player ;)
  var myVideo = document.createElement("video");
  myVideo.id="myVideo";
  myVideo.controls=true;
  myVideo.width=playerWidth;
  myVideo.disabled=true;
  $("#myResizable").append(myVideo);

  var myGetDuration = function(){
    return myVideo.duration;
  }

  var myGetCurrentTime = function(){
    return myVideo.currentTime;
  }

  var initResizable = function(){
    $("#myResizable" ).resizable({
      alsoResize: "#myVideo",
      aspectRatio: true,
      minWidth: 352,
      create: function(e,ui){
        myVideo.width=playerWidth;
        $("#slider").width(playerWidth);
      },
      resize: function(event,ui){
        $("#slider").width(ui.size.width);
      }
    });
  };

  var playSelectedFile = function (f) {
    cancelABLoop();

    slowButton.value="Slow";
    loopButton.disabled=true;

    //remove all bookmark items from previous video
    bmkDelete(0);

    //replace #myResizable container and its #myVideo child
    myResizable = document.getElementById("myResizable");
    var parent = myResizable.parentNode;
    var myResizableOld=myResizable;
    myResizable = document.createElement("div");
    myResizable.id="myResizable";
    parent.replaceChild(myResizable, myResizableOld);
    myVideo = document.createElement("video");
    myVideo.id="myVideo";
    myVideo.addEventListener("mouseover", function(e){e.target.controls=true;}); 
    myVideo.addEventListener("mouseout", function(e){e.target.controls=false;}); 
    myVideo.controls=null;
    myResizable.appendChild(myVideo);

    //set video source and add event listeners
    vidId = f.name+'-'+f.size; //some checksum would be better
    var fileURL = URL.createObjectURL(f);
    myVideo.addEventListener("canplay", onCanPlay);
    myVideo.src=fileURL;

    //look for bookmark items with this video ID
    if(localStorage.getItem(vidId)){
      var bmks = localStorage.getItem(vidId).split(',');
      for(var i=0; i<bmks.length; i++){
        bmkAdd(bmks[i]);
        myBookmarks.options[0].hidden=false;
        myBookmarks.options[0].selected=true;
      }
      annotButton.disabled=true;
    }
  }

  var onCanPlay = function () {
    loopButton.disabled=false;
    initResizable();
  }

  var onBmkSelect = function(i){
    cancelABLoop();
    if(i==0) return;

    var a=timeStringToSec(myBookmarks.options[i].text.split('--')[0]);
    var b=timeStringToSec(myBookmarks.options[i].text.split('--')[1]);
    $("#slider").slider("option", "max", myGetDuration());
    $("#slider").slider("option", "values", [a, b]);
    isTimeASet=isTimeBSet=true;
    timeInputs.hidden=false;
    loopButton.value="Cancel";
    myBookmarks.options[0].hidden=true;
    annotButton.disabled=false;
    myVideo.addEventListener('timeupdate',onTimeUpdate);
  }

  var cancelABLoop = function () {
    myVideo.removeEventListener('timeupdate',onTimeUpdate);
    isTimeASet=isTimeBSet=false;
    loopButton.value="A";
    timeInputs.hidden=true;
  }

  var onTimeUpdate = function () {
    if(myVideo.paused) return;
    if(myGetCurrentTime()<timeA || myGetCurrentTime()>=timeB)
      myVideo.currentTime=timeA;
  }

  var onLoopDown = function () {
    if(isTimeBSet){
      cancelABLoop();
      annotButton.disabled=true;
      myBookmarks.options[0].hidden=false;
      myBookmarks.options[0].selected=true;
    }else{
      if(isTimeASet){
        if(myGetCurrentTime()!=timeA){
          if(myGetCurrentTime()<timeA){
            timeB=timeA;
            timeA=myGetCurrentTime();
          }else{
            timeB=myGetCurrentTime();
          }
          isTimeBSet=true;
          loopButton.value="Cancel";
          $("#slider").slider("option", "max", myGetDuration());
          $("#slider").slider("option", "values", [ timeA, timeB ]);
          timeInputs.hidden=false;

          myVideo.addEventListener('timeupdate',onTimeUpdate);
        }
      }else{
        timeA=myGetCurrentTime();
        isTimeASet=true;
        loopButton.value="B";
      }
    }
  }

  var onSlowDown = function () {
    if(myVideo.playbackRate==myVideo.defaultPlaybackRate){
      myVideo.playbackRate=0.5;
      slowButton.value="Fast";
    }else if(myVideo.playbackRate==0.5){
      myVideo.playbackRate=2;
      slowButton.value="Normal";
    }else{
      myVideo.playbackRate=myVideo.defaultPlaybackRate;
      slowButton.value="Slow";
    }
  }
</script>

</body>
</html>
